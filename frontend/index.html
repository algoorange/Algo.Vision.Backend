<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Vision Recognition</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
  <!-- Top menu bar -->
  <div class="menu-bar">
    <button onclick="viewAction()">View</button>
    <label for="videoFile" class="upload-btn">Upload</label>
    <button onclick="toggleVideoDropdown()">Show Videos</button>
  </div>

  <!-- Hidden file input for upload -->
  <form id="uploadForm">
    <input type="file" id="videoFile" accept="video/*" required hidden />
    <button type="submit">Submit Upload</button>
  </form>

  <!-- Dropdown for videos -->
  <div id="videoDropdown" style="display:none; background:#f1f1f1; padding:10px;">
    <!-- Video list will appear here -->
  </div>

  <!-- Main content -->
  <div class="main-flex-layout">
    <!-- Sidebar for video list -->
    <div id="videoListSidebar">
      <div class="sidebar-title">Uploaded Videos</div>
      <div id="videoList"></div>
    </div>
    <!-- Main content area: frames grid and chat -->
    <div class="main-content">
      <div class="video">
        <p id="status"></p>
        <div id="loaderContainer" style="display:none;">
          <div class="loader"></div>
        </div>
        <!-- Frames Grid -->
        <div id="framesGrid"> </div>
      </div>
      <div class="chat">
        <div id="chatMessages">
          <div class="message bot">Hello! I’m your vision assistant.</div>
        </div>
        <div class="input-area">
          <input type="text" id="chatInput" placeholder="Ask a question..." onkeypress="if(event.key==='Enter') sendMsg()">
          <button onclick="sendMsg()">Send</button>
        </div>
      </div>
    </div>
  </div>

  <script>
// Global variable to track the currently selected or uploaded video
let lastUploadedVideoId = null;


    // --- Video List Sidebar Logic ---
    async function loadVideoListSidebar() {
      const videoListDiv = document.getElementById('videoList');
      videoListDiv.innerHTML = '<div style="color:#888; padding:10px;">Loading videos...</div>';
      try {
        const resp = await fetch('http://localhost:8000/videos/list');
        const videos = await resp.json();
        if (!videos.length) {
          videoListDiv.innerHTML = '<div style="color:#888; padding:10px;">No videos uploaded.</div>';
          return;
        }
        videoListDiv.innerHTML = '';
        videos.forEach(filename => {
          // Extract video_id from filename (assumes format: {uuid}_{original_filename})
          const videoId = filename.split('_')[0];
          const displayName = filename.split('_')[1];
          const card = document.createElement('div');
          card.className = 'video-card';
          card.title = filename;
          card.textContent = displayName;
          card.onclick = () => {
            loadFramesGrid(videoId);
            loadChatHistory(videoId);
            lastUploadedVideoId = videoId;
          };
          
          videoListDiv.appendChild(card);

        });
      } catch (err) {
        videoListDiv.innerHTML = '<div style="color:#f55; padding:10px;">Failed to load videos.</div>';
      }
    }
    // Load video list on page load
    window.addEventListener('DOMContentLoaded', loadVideoListSidebar);

    // Handle file upload and start live stream
    const uploadForm = document.getElementById("uploadForm");
    const status = document.getElementById("status");
    const chatMessages = document.getElementById("chatMessages");

uploadForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const fileInput = document.getElementById("videoFile");
    const file = fileInput.files[0];
    if (!file) return alert("Please select a video file!");

    const formData = new FormData();
    formData.append("file", file);

    try {
        document.getElementById("loaderContainer").style.display = "block";
        const response = await fetch("http://localhost:8000/upload/", {
            method: "POST",
            body: formData,
        });
        const result = await response.json();
        console.log(result);
        document.getElementById("loaderContainer").style.display = "none";
        lastUploadedVideoId = result.video_id;

        // Update frames grid for this upload
        await loadFramesGrid(result.video_id);
        await loadChatHistory(result.video_id);

        // Add result summary to chat
        chatMessages.innerHTML += `
            <div class="message bot">
                <b>Video Summary:</b><br>
                ${result.natural_language_summary}<br>
                <b>Details:</b>
                Total Frames: ${result.summary.total_frames}, 
                FPS: ${result.summary.fps}, 
                Duration: ${result.summary.duration_seconds},
                Cracks Detected: ${result.summary.crack_count}
            </div>
        `;
        chatMessages.scrollTop = chatMessages.scrollHeight;

        // Store the summary in MongoDB for this video
        const summaryText = `${result.natural_language_summary}\nDetails: Total Frames: ${result.summary.total_frames}, FPS: ${result.summary.fps}, Duration: ${result.summary.duration_seconds}, Cracks Detected: ${result.summary.crack_count}`;
        await saveChatMessage(result.video_id, summaryText, "bot", summaryText);

    } catch (err) {
        console.error(err);
        document.getElementById("loaderContainer").style.display = "none";
    }
});

async function loadChatHistory(videoId) {
  const chatMessages = document.getElementById('chatMessages');
  chatMessages.innerHTML = ''; // Clear chat box

  try {
    // Show loading message
    chatMessages.innerHTML = '<div class="message bot">Loading chat history...</div>';

    // Fetch chat history for the selected video
    const resp = await fetch(`http://localhost:8000/videos/user_chat_history_fetch?video_id=${encodeURIComponent(videoId)}`);
    const history = await resp.json();

    // If there are no messages, show a friendly message
    if (!history || !Array.isArray(history.messages) || history.messages.length === 0) {
      return;
    }

    // Build the chat HTML
    let html = '';
    if (history.summary) {
      html += `<div class="message bot"><b>Video Summary:</b><br>${history.summary}</div>`;
    }
    history.messages.forEach(msg => {
      if (msg && msg.role && msg.text && msg.text !== history.summary) {
        html += `<div class="message ${msg.role}">${msg.text}</div>`;
      }
    });

    chatMessages.innerHTML = html;
    chatMessages.scrollTop = chatMessages.scrollHeight;
  } catch (err) {
    chatMessages.innerHTML = '<div class="message bot">❌ Failed to load chat history.</div>';
  }
}

async function saveChatMessage(videoId, summary, role, text) {
  const body = { video_id: videoId, role, text };
  if (summary) body.summary = summary;
  await fetch("http://localhost:8000/videos/user_chat_history", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(body)
  });
}  

async function sendMsg() {
  const input = document.getElementById('chatInput');
  const message = input.value.trim();
  if (!message) return;

  // Show user message
  const chatMessages = document.getElementById('chatMessages');
  chatMessages.innerHTML += `<div class="message user">${message}</div>`;
  input.value = '';

  // Save user message to MongoDB (no summary for chat, so pass empty string)
  if (lastUploadedVideoId) {
    await saveChatMessage(lastUploadedVideoId, "", "user", message);
  }

  try {
    // Send question to backend and get bot answer
    const resp = await fetch('http://localhost:8000/query/', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ video_id: lastUploadedVideoId, question: message })
    });
    const result = await resp.json();
    if (result && result.answer) {
      // Show bot answer in chat
      chatMessages.innerHTML += `<div class="message bot">${result.answer}</div>`;
      // Save bot answer to MongoDB (no summary)
      await saveChatMessage(lastUploadedVideoId, "", "bot", result.answer);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }
  } catch (err) {
    chatMessages.innerHTML += '<div class="message bot">❌ Failed to get answer from server.</div>';
  }
}


    // --- Frames Grid Logic ---
    // Loads and displays frames for a given video ID
async function loadFramesGrid(videoId = null) {
  const grid = document.getElementById('framesGrid');
  // Show loading or status message
  grid.innerHTML = '<div style="color:#888">Loading frames...</div>';

  // Determine which video ID to use
  let chosenVideoId = videoId || lastUploadedVideoId;
  if (!chosenVideoId) {
    grid.innerHTML = '<div style="color:#888">No frames found.</div>';
    return;
  }

  // Build the API query URL
  const query = `?video_id=${encodeURIComponent(chosenVideoId)}`;
  const apiUrl = `http://localhost:8000/videos/frames/list${query}`;

  try {
    // Fetch the list of frames from the backend
    const response = await fetch(apiUrl);
    const frames = await response.json();

    // If there are no frames, show a message
    if (!frames.length) {
      grid.innerHTML = '<div style="color:#888">No frames found.</div>';
      return;
    }

    // Clear the grid and add each frame as a card
    grid.innerHTML = '';
    frames.forEach((filename, idx) => {
      // Create a container for each frame
      const frameBox = document.createElement('div');
      frameBox.className = 'frame-box';

      // Set the frame image and label
      frameBox.innerHTML = `
        <img src="http://localhost:8000/frames/${chosenVideoId}/${filename}" class="frame-img" />
        <div class="frame-label">Frame ${idx + 1}</div>
      `;
      grid.appendChild(frameBox);
    });
  } catch (error) {
    // Show error message if something goes wrong
    grid.innerHTML = '<div style="color:#f55">Failed to load frames.</div>';
  }
}

    // Load frames on page load
    window.addEventListener('DOMContentLoaded', () => loadFramesGrid());
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Vision Recognition</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
  <!-- Top menu bar -->
  <div class="menu-bar">
    <button onclick="viewAction()">View</button>
    <label for="videoFile" class="upload-btn">Upload</label>
    <button onclick="toggleVideoDropdown()">Show Videos</button>
  </div>

  <!-- Hidden file input for upload -->
  <form id="uploadForm">
    <input type="file" id="videoFile" accept="video/*" required hidden />
    <button type="submit">Submit Upload</button>
</form>

  <!-- Dropdown for videos -->
  <div id="videoDropdown" style="display:none; background:#f1f1f1; padding:10px;">
    <!-- Video list will appear here -->
  </div>

  <!-- Main content -->
  <div class="container">
    <div class="video">
      <p id="status"></p>
      <div id="loaderContainer" style="display:none;">
        <div class="loader"></div>
      </div>
      <!-- Frames Grid -->
      <div id="framesGrid"> </div>
    </div>
    <div class="chat">
      <div id="chatMessages">
        <div class="message bot">Hello! I’m your vision assistant.</div>
      </div>
      <div class="input-area">
        <input type="text" id="chatInput" placeholder="Ask a question..." onkeypress="if(event.key==='Enter') sendMsg()">
        <button onclick="sendMsg()">Send</button>
      </div>
    </div>
  </div>

  <script>
 // Handle file upload and start live stream
 const uploadForm = document.getElementById("uploadForm");
 const status = document.getElementById("status");
 const chatMessages = document.getElementById("chatMessages");

 let lastUploadedVideoId = null;

uploadForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const fileInput = document.getElementById("videoFile");
    const file = fileInput.files[0];
    if (!file) return alert("Please select a video file!");

    const formData = new FormData();
    formData.append("file", file);

    try {
        document.getElementById("loaderContainer").style.display = "block";
        const response = await fetch("http://localhost:8000/upload/", {
            method: "POST",
            body: formData,
        });
        const result = await response.json();
        console.log(result);
        document.getElementById("loaderContainer").style.display = "none";
        lastUploadedVideoId = result.video_id;

        // Update frames grid for this upload
        await loadFramesGrid(result.video_id);

        // Add result summary to chat
        chatMessages.innerHTML += `
            <div class="message bot">
                <b>Video Summary:</b><br></n>
                ${result.natural_language_summary}<br></n>
                <b>Details:</b></n>
                Total Frames: ${result.summary.total_frames}</n>, 
                FPS: ${result.summary.fps}</n>, 
                Duration: ${result.summary.duration_seconds}</n>,
                Cracks Detected: ${result.summary.crack_count}</n>
            </div>
        `;
        chatMessages.scrollTop = chatMessages.scrollHeight;

    } catch (err) {
        console.error(err);
        document.getElementById("loaderContainer").style.display = "none";
    }
});

async function sendMsg() {
    const input = document.getElementById('chatInput');
    const message = input.value.trim();
    if (!message) return;

    // Show user message
    const chatMessages = document.getElementById('chatMessages');
    chatMessages.innerHTML += `<div class="message user">${message}</div>`;
    input.value = '';

    try {
        const response = await fetch("http://localhost:8000/query/", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ question: message })  // ✅ wrap question
        });

        const result = await response.json();
        console.log(result);

        // Show bot response
        chatMessages.innerHTML += `<div class="message bot">${result.answer}</div>`;
        chatMessages.scrollTop = chatMessages.scrollHeight;

    } catch (err) {
        console.error(err);
        chatMessages.innerHTML += `<div class="message bot">❌ Error: Could not fetch response.</div>`;
    }
}

    // --- Frames Grid Logic ---
    async function loadFramesGrid(videoId = null) {
      const grid = document.getElementById('framesGrid');
      grid.innerHTML = status.innerHTML;
      try {
        let query = '';
        if (videoId) {
          query = `?video_id=${encodeURIComponent(videoId)}`;
        } else if (lastUploadedVideoId) {
          query = `?video_id=${encodeURIComponent(lastUploadedVideoId)}`;
        } else {
          grid.innerHTML = '<div style="color:#888">No frames found.</div>';
          return;
        }
        const resp = await fetch(`http://localhost:8000/videos/frames/list${query}`);
        const frames = await resp.json();
        if (!frames.length) {
          grid.innerHTML = '<div style="color:#888">No frames found.</div>';
          return;
        }
        grid.innerHTML = '';
        frames.forEach((filename, idx) => {
          const frameBox = document.createElement('div');
          frameBox.className = 'frame-box';
          frameBox.innerHTML = `
            <img src="http://localhost:8000/frames/${videoId || lastUploadedVideoId}/${filename}" class="frame-img" />
            <div class="frame-label">F${idx+1}</div>
          `;
          grid.appendChild(frameBox);
        });
      } catch (e) {
        grid.innerHTML = '<div style="color:#f55">Failed to load frames.</div>';
      }
    }
    // Load frames on page load
    window.addEventListener('DOMContentLoaded', () => loadFramesGrid());
  </script>
</body>
</html>
